import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// Supported languages
export type Language = 'vi' | 'en';

// Translation keys
export const translations = {
    vi: {
        // Home
        appName: 'GoXPrint',
        appTagline: 'Công cụ in ấn chuyên nghiệp',
        paperCalc: 'Tính giấy cắt',
        paperCalcSub: 'Tối ưu cắt giấy',
        impositionCalc: 'Tính bình trang',
        impositionCalcSub: 'Xếp hình tối ưu',
        materialCalc: 'Tính vật tư',
        materialCalcSub: 'Ước tính chi phí',
        footer: 'Miễn phí cho ngành in',

        // Common
        back: 'Quay lại',
        reset: 'Làm mới',
        version: 'v1.0',
        close: 'Đóng',

        // Imposition Calculator
        impTitle: 'Tính Bình Trang',
        shapeLabel: 'Hình dạng sản phẩm',
        shapeRect: 'Chữ nhật',
        shapeCircle: 'Tròn',
        shapeOval: 'Oval',
        productSize: 'Kích thước sản phẩm',
        width: 'Chiều rộng',
        height: 'Chiều cao',
        spacing: 'Khoảng cách',
        paperSize: 'Khổ giấy in',
        pageWidth: 'Rộng',
        pageHeight: 'Cao',
        printArea: 'Vùng in thực tế (Áp dụng cho decal)',
        orderPrice: 'Đơn hàng & Giá',
        orderQty: 'Số lượng đặt',
        pricePerSheet: 'Giá in/tờ',
        itemsPerSheet: 'Tem/tờ',
        totalSheets: 'Số tờ',
        pricePerItem: 'Đ/tem',
        totalCost: 'Tổng',
        selectPlan: 'Chọn phương án',
        layoutDiagram: 'Sơ đồ xếp hình',
        noLayoutFound: 'Không tìm thấy phương án phù hợp. Hãy thử giảm kích thước sản phẩm.',
        plans: 'phương án',
        selected: 'Đang chọn',
        straightLayout: 'Xếp thẳng',
        honeycombLayout: 'Xếp sole (tối ưu)',
        honeycombDesc: 'Xếp kiểu tổ ong, ~15% hiệu quả hơn',
        landscapeLayout: 'Tất cả ngang',
        cols: 'cột',
        rows: 'hàng',
        rotated: 'xoay',
        pcs: 'cái',
        currency: 'đ',
        mm: 'mm',

        // Paper Calculator
        paperCalcTitle: 'Tính Giấy Cắt',
        tabOptimize: 'Tối ưu',
        tabDivide: 'Chia khổ',
        paperSheet: 'Tờ giấy lớn',
        paperPrice: 'Giá giấy',
        cutterMaxLen: 'Dài tối đa máy xén',
        productItem: 'Sản phẩm',
        result: 'Kết quả',
        sheetsPerBigSheet: 'tờ/tờ lớn',
        pricePerSmallSheet: 'Giá/tờ nhỏ',
        showPreview: 'Xem trước',
        hidePreview: 'Ẩn xem trước',
        cuttingGuide: 'Hướng dẫn cắt',
        targetQty: 'SL mục tiêu',
        minSize: 'Kích thước tối thiểu',
        maxSize: 'Kích thước tối đa',
        showMore: 'Xem thêm',
        options: 'phương án',
        bestOption: 'Tốt nhất',
        selectThis: 'Chọn',
        selectedOption: 'Đã chọn',
        step: 'Bước',
        cut: 'Cắt',
        horizontal: 'ngang',
        vertical: 'dọc',
        atPosition: 'tại vị trí',
        fromEdge: 'từ mép',
        length: 'Dài',
        widthLabel: 'Rộng',
        bigPaperSize: 'Khổ Giấy Lớn',
        bigPaperPrice: 'Giá giấy lớn',
        maxCutterLen: 'Dài max xén',
        productMM: 'Thành phẩm (mm)',
        swapDimension: 'Đổi chiều',
        calculating: 'Đang tính toán...',
        maxQty: 'Số lượng tối đa',
        unit: 'con',
        pricePerPc: 'đ/con',
        tabOptimizeSize: 'Tối ưu cắt (Nhập Size)',
        tabDivideQty: 'Chia số lượng',
        optimizeResult: 'Kết quả tối ưu nhất',
        noResult: 'Không tìm thấy kết quả phù hợp',
        sizeError: 'Kích thước sản phẩm lớn hơn khổ giấy',
        targetQtyLabel: 'SL mục tiêu',
        minSizeLabel: 'Kích thước tối thiểu',
        maxSizeLabel: 'Kích thước tối đa (0 = tự do)',
        divideOptions: 'Các phương án chia',
        noOptions: 'Không có phương án phù hợp',
        preview: 'Xem trước',
        cutterMaxLabel: 'Máy xén (chiều dài)',
        examplePrice: 'VD: 5000',
        allVertical: 'Tất cả Dọc',
        allHorizontal: 'Tất cả Ngang',
        colsText: 'cột',
        rowsText: 'hàng',
        cutGuide: 'Hướng dẫn cắt',
        compareOptions: 'So sánh phương án',
        inputSizeToCalc: 'Nhập kích thước để tính toán',
        qtyAndFilter: 'Số lượng & Bộ lọc',
        findLargestSize: 'Tìm kích thước lớn nhất cho số lượng này',
        sizeFilter: 'Bộ lọc kích thước (Min - Max):',
        minLen: 'Min Dài',
        maxLen: 'Max Dài',
        minWid: 'Min Rộng',
        maxWid: 'Max Rộng',
        optionsCount: 'phương án',
        guide: 'Hướng dẫn',
        products: 'sản phẩm',

        // Material Calculator
        materialCalcTitle: 'Tính Vật Tư',
        modeSheet: 'Tờ',
        modeRoll: 'Cuộn',
        sheetMaterial: 'Tấm vật liệu',
        rollMaterial: 'Cuộn vật liệu',
        rollWidth: 'Khổ cuộn',
        totalLength: 'Tổng chiều dài',
        sheetsNeeded: 'Số tờ cần',
        usagePercent: 'Hiệu suất',
        waste: 'Phế liệu',
        lengthUsed: 'Chiều dài sử dụng',
        lengthWaste: 'Chiều dài thừa',
        arrangement: 'Cách xếp',
        quantity: 'Số lượng',
        addRollWidth: 'Thêm khổ cuộn',
        rollWidths: 'Các khổ cuộn',
        resultTitle: 'Kết quả',
        totalUsage: 'Tổng sử dụng',
        efficiency: 'Hiệu suất',
        sheetMode: 'Dạng Tờ',
        rollMode: 'Dạng Cuộn',
        qtyNeeded: 'Số lượng cần',
        swapBtn: 'Đảo chiều',
        materialSheet: 'Khổ Giấy Nguyên Liệu',
        materialRoll: 'Khổ Cuộn Nguyên Liệu',
        sheetLength: 'Khổ Dài',
        sheetWidth: 'Khổ Rộng',
        sheetPrice: 'Giá nhập (tờ lớn)',
        rollWidthInput: 'Khổ Rộng (Nhập nhiều để so sánh)',
        addOtherWidth: 'Thêm khổ khác',
        pricePerSqm: 'Giá theo m²',
        pricePerMeter: 'Giá theo md',
        unitPriceSqm: 'Đơn giá m²',
        unitPriceMeter: 'Đơn giá mét dài',
        viewingWidth: 'Đang xem khổ',
        priceNote: '*Lưu ý: Giá md này sẽ áp dụng cho tất cả các khổ đang nhập.',
        material: 'Vật tư',
        unitPrice: 'Đơn giá',
        totalPrice: 'Tổng tiền',
        sheet: 'tờ',
        meter: 'm',
        optimalOption: 'Tối ưu',
        lengthNeeded: 'Cần',
        viewDiagram: 'XEM SƠ ĐỒ',
        pcsPerMeter: 'con/m',
        best: 'Tốt nhất',
        cuttingDiagram: 'Sơ đồ cắt',
        bigSheet: 'Giấy lớn',
        layoutType: 'Kiểu ghép',
        pcsPerSheet: 'Con / Tờ',
        pcsPerM: 'Con / Mét',
        edgeWaste: 'Bù hao biên (mép thừa)',

        // Cutting Simulation
        cutSimulation: '✂️ Mô phỏng cắt',
        cluster1: 'Cụm 1',
        cluster2: 'Cụm 2',
        productLabel: 'Sản phẩm',
        stop: 'Dừng',
        play: 'Chạy',
        print: 'In',

        // Cutting Guide Modal
        cuttingGuideTitle: 'Hướng dẫn cắt',
        paperInfo: 'Giấy',
        productsCount: 'sản phẩm',
        twoClusters: '2 cụm',
        cutDivideClusters: 'Cắt chia 2 cụm',
        priorityCut: 'Ưu tiên cắt trước',
        cutProducts: 'Cắt sản phẩm',
        priorityLabel: 'ưu tiên',
        rowsLabel: 'hàng',
        colsLabel: 'cột',
        hLines: 'đường ngang',
        vLines: 'đường dọc',
        hLinesShort: 'đường H',
        vLinesShort: 'đường V',
        cutThen: 'rồi',
        summaryTitle: 'Tổng kết',
        totalCutLines: 'Tổng đường cắt',
        linesUnit: 'đường',
        totalProductsLabel: 'Tổng sản phẩm',
        quickCuttingTips: 'Mẹo cắt nhanh',
        tipStackSheets: 'Xếp chồng nhiều tờ để cắt 1 lần',
        tipCutterLength: 'Chiều dài máy xén',
        tipEdgeCut: 'Đường cắt từ mép → bao gồm phần thừa',
        understood: 'Đã hiểu, đóng',
        fastestProduct: 'Ra thành phẩm sớm nhất!',
        cutOneLine: 'Cắt 1 đường để tách 2 cụm',
        minCutFormula: 'min',

        // Division Results
        totalCount: 'Tổng số',
        areaLabel: 'Diện tích',
        priceLabel: 'Giá',
        pricePerUnitShort: 'đ/con',
        showMoreOptions: 'Xem thêm',
        moreOptionsText: 'phương án',
        noMatchingPlan: 'Không tìm thấy phương án phù hợp',
        tryAdjusting: 'Thử điều chỉnh số lượng hoặc kích thước Min/Max',
        finishedPrice: 'Giá thành phẩm',

        // Material Calculator descriptions
        verticalLayout: 'Dọc',
        horizontalLayout: 'Ngang',
        mixLayout: 'Mix Dọc + Ngang',
        allVerticalLayout: 'Dọc toàn bộ',
        allHorizontalLayout: 'Ngang toàn bộ',
        productTooLarge: 'Sản phẩm lớn hơn khổ giấy!',
        noMatchingWidth: 'Không tìm thấy khổ phù hợp hoặc chưa nhập khổ!',

        // Download Tool
        downloadTool: 'Tải công cụ',
        downloadToolSub: 'Hỗ trợ cài máy in',
        downloadToolDesc: 'Công cụ GoXPrint giúp bạn cài đặt và cấu hình máy in nhanh chóng. Tải về và chạy file cài đặt để bắt đầu.',
        downloadBtn: 'Tải về ngay',
    },
    en: {
        // Home
        appName: 'GoXPrint',
        appTagline: 'Professional printing tools',
        paperCalc: 'Paper Calculator',
        paperCalcSub: 'Cut optimization',
        impositionCalc: 'Imposition Calc',
        impositionCalcSub: 'Layout planning',
        materialCalc: 'Material Calc',
        materialCalcSub: 'Cost estimation',
        footer: 'Free for printing industry',

        // Common
        back: 'Back',
        reset: 'Reset',
        version: 'v1.0',
        close: 'Close',

        // Imposition Calculator
        impTitle: 'Imposition Calculator',
        shapeLabel: 'Product Shape',
        shapeRect: 'Rectangle',
        shapeCircle: 'Circle',
        shapeOval: 'Oval',
        productSize: 'Product Size',
        width: 'Width',
        height: 'Height',
        spacing: 'Spacing',
        paperSize: 'Paper Size',
        pageWidth: 'Width',
        pageHeight: 'Height',
        printArea: 'Print Area (For decals)',
        orderPrice: 'Order & Price',
        orderQty: 'Order Qty',
        pricePerSheet: 'Price/Sheet',
        itemsPerSheet: 'Items/Sheet',
        totalSheets: 'Sheets',
        pricePerItem: '$/Item',
        totalCost: 'Total',
        selectPlan: 'Select Layout',
        layoutDiagram: 'Layout Diagram',
        noLayoutFound: 'No suitable layout found. Try reducing product size.',
        plans: 'layouts',
        selected: 'Selected',
        straightLayout: 'Straight',
        honeycombLayout: 'Honeycomb (optimal)',
        honeycombDesc: 'Honeycomb pattern, ~15% more efficient',
        landscapeLayout: 'All Landscape',
        cols: 'cols',
        rows: 'rows',
        rotated: 'rotated',
        pcs: 'pcs',
        currency: '$',
        mm: 'mm',

        // Paper Calculator
        paperCalcTitle: 'Paper Calculator',
        tabOptimize: 'Optimize',
        tabDivide: 'Divide',
        paperSheet: 'Paper Sheet',
        paperPrice: 'Paper Price',
        cutterMaxLen: 'Max Cutter Length',
        productItem: 'Product',
        result: 'Result',
        sheetsPerBigSheet: 'sheets/big sheet',
        pricePerSmallSheet: 'Price/small sheet',
        showPreview: 'Show Preview',
        hidePreview: 'Hide Preview',
        cuttingGuide: 'Cutting Guide',
        targetQty: 'Target Qty',
        minSize: 'Min Size',
        maxSize: 'Max Size',
        showMore: 'Show More',
        options: 'options',
        bestOption: 'Best',
        selectThis: 'Select',
        selectedOption: 'Selected',
        step: 'Step',
        cut: 'Cut',
        horizontal: 'horizontal',
        vertical: 'vertical',
        atPosition: 'at position',
        fromEdge: 'from edge',
        length: 'Length',
        widthLabel: 'Width',
        bigPaperSize: 'Big Paper Size',
        bigPaperPrice: 'Big Paper Price',
        maxCutterLen: 'Max Cutter Len',
        productMM: 'Product (mm)',
        swapDimension: 'Swap',
        calculating: 'Calculating...',
        maxQty: 'Maximum Quantity',
        unit: 'pcs',
        pricePerPc: '$/pcs',
        tabOptimizeSize: 'Optimize (Input Size)',
        tabDivideQty: 'Divide Quantity',
        optimizeResult: 'Best optimization result',
        noResult: 'No suitable result found',
        sizeError: 'Product size is larger than paper size',
        targetQtyLabel: 'Target Qty',
        minSizeLabel: 'Minimum size',
        maxSizeLabel: 'Maximum size (0 = auto)',
        divideOptions: 'Division Options',
        noOptions: 'No suitable options',
        preview: 'Preview',
        cutterMaxLabel: 'Cutter (max length)',
        examplePrice: 'E.g. 5000',
        allVertical: 'All Vertical',
        allHorizontal: 'All Horizontal',
        colsText: 'cols',
        rowsText: 'rows',
        cutGuide: 'Cutting Guide',
        compareOptions: 'Compare Options',
        inputSizeToCalc: 'Enter size to calculate',
        qtyAndFilter: 'Quantity & Filter',
        findLargestSize: 'Find largest size for this quantity',
        sizeFilter: 'Size filter (Min - Max):',
        minLen: 'Min Length',
        maxLen: 'Max Length',
        minWid: 'Min Width',
        maxWid: 'Max Width',
        optionsCount: 'options',
        guide: 'Guide',
        products: 'products',

        // Material Calculator
        materialCalcTitle: 'Material Calculator',
        modeSheet: 'Sheet',
        modeRoll: 'Roll',
        sheetMaterial: 'Sheet Material',
        rollMaterial: 'Roll Material',
        rollWidth: 'Roll Width',
        totalLength: 'Total Length',
        sheetsNeeded: 'Sheets Needed',
        usagePercent: 'Efficiency',
        waste: 'Waste',
        lengthUsed: 'Length Used',
        lengthWaste: 'Length Waste',
        arrangement: 'Arrangement',
        quantity: 'Quantity',
        addRollWidth: 'Add Roll Width',
        rollWidths: 'Roll Widths',
        resultTitle: 'Result',
        totalUsage: 'Total Usage',
        efficiency: 'Efficiency',
        sheetMode: 'Sheet Mode',
        rollMode: 'Roll Mode',
        qtyNeeded: 'Quantity Needed',
        swapBtn: 'Swap',
        materialSheet: 'Material Sheet Size',
        materialRoll: 'Material Roll Size',
        sheetLength: 'Sheet Length',
        sheetWidth: 'Sheet Width',
        sheetPrice: 'Sheet Price',
        rollWidthInput: 'Roll Width (Multiple for comparison)',
        addOtherWidth: 'Add other width',
        pricePerSqm: 'Price per m²',
        pricePerMeter: 'Price per meter',
        unitPriceSqm: 'Unit price m²',
        unitPriceMeter: 'Unit price per meter',
        viewingWidth: 'Viewing width',
        priceNote: '*Note: This price applies to all widths entered.',
        material: 'Material',
        unitPrice: 'Unit Price',
        totalPrice: 'Total Price',
        sheet: 'sheets',
        meter: 'm',
        optimalOption: 'Optimal',
        lengthNeeded: 'Need',
        viewDiagram: 'VIEW DIAGRAM',
        pcsPerMeter: 'pcs/m',
        best: 'Best',
        cuttingDiagram: 'Cutting Diagram',
        bigSheet: 'Big Sheet',
        layoutType: 'Layout Type',
        pcsPerSheet: 'Pcs / Sheet',
        pcsPerM: 'Pcs / Meter',
        edgeWaste: 'Edge waste (margin)',

        // Cutting Simulation
        cutSimulation: '✂️ Cutting Simulation',
        cluster1: 'Cluster 1',
        cluster2: 'Cluster 2',
        productLabel: 'Product',
        stop: 'Stop',
        play: 'Play',
        print: 'Print',

        // Cutting Guide Modal
        cuttingGuideTitle: 'Cutting Guide',
        paperInfo: 'Paper',
        productsCount: 'products',
        twoClusters: '2 clusters',
        cutDivideClusters: 'Divide into 2 clusters',
        priorityCut: 'Priority cut first',
        cutProducts: 'Cut products',
        priorityLabel: 'priority',
        rowsLabel: 'rows',
        colsLabel: 'cols',
        hLines: 'horizontal lines',
        vLines: 'vertical lines',
        hLinesShort: 'H lines',
        vLinesShort: 'V lines',
        cutThen: 'then',
        summaryTitle: 'Summary',
        totalCutLines: 'Total cut lines',
        linesUnit: 'lines',
        totalProductsLabel: 'Total products',
        quickCuttingTips: 'Quick cutting tips',
        tipStackSheets: 'Stack multiple sheets to cut at once',
        tipCutterLength: 'Cutter max length',
        tipEdgeCut: 'Cut from edge → includes waste',
        understood: 'Got it, close',
        fastestProduct: 'Yields products fastest!',
        cutOneLine: 'Cut 1 line to separate 2 clusters',
        minCutFormula: 'min',

        // Division Results
        totalCount: 'Total',
        areaLabel: 'Area',
        priceLabel: 'Price',
        pricePerUnitShort: '$/pc',
        showMoreOptions: 'Show more',
        moreOptionsText: 'options',
        noMatchingPlan: 'No matching plan found',
        tryAdjusting: 'Try adjusting quantity or Min/Max size',
        finishedPrice: 'Finished product price',

        // Material Calculator descriptions
        verticalLayout: 'Vertical',
        horizontalLayout: 'Horizontal',
        mixLayout: 'Mix Vertical + Horizontal',
        allVerticalLayout: 'All Vertical',
        allHorizontalLayout: 'All Horizontal',
        productTooLarge: 'Product larger than paper!',
        noMatchingWidth: 'No matching width found or width not entered!',

        // Download Tool
        downloadTool: 'Download Tool',
        downloadToolSub: 'Printer installation support',
        downloadToolDesc: 'GoXPrint tool helps you install and configure printers quickly. Download and run the installer to get started.',
        downloadBtn: 'Download now',
    }
};

interface I18nContextType {
    lang: Language;
    setLang: (lang: Language) => void;
    t: (key: keyof typeof translations.vi) => string;
}

const I18nContext = createContext<I18nContextType | null>(null);

// Detect browser language
const detectLanguage = (): Language => {
    // Check localStorage first
    const saved = localStorage.getItem('goxprint_lang');
    if (saved === 'vi' || saved === 'en') return saved;

    // Check browser language
    const browserLang = navigator.language || (navigator as any).userLanguage || 'en';
    if (browserLang.startsWith('vi')) return 'vi';

    return 'en';
};

export const I18nProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
    const [lang, setLangState] = useState<Language>('vi');

    useEffect(() => {
        setLangState(detectLanguage());
    }, []);

    const setLang = (newLang: Language) => {
        setLangState(newLang);
        localStorage.setItem('goxprint_lang', newLang);
    };

    const t = (key: keyof typeof translations.vi): string => {
        return translations[lang][key] || key;
    };

    return (
        <I18nContext.Provider value={{ lang, setLang, t }}>
            {children}
        </I18nContext.Provider>
    );
};

export const useI18n = () => {
    const context = useContext(I18nContext);
    if (!context) {
        throw new Error('useI18n must be used within I18nProvider');
    }
    return context;
};
